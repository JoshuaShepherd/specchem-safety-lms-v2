# Check-in: Database & Schema Integration Validation

## Safety Business Schema Integration Assessment

**Required Context Files:**
- `apps/crm/src/lib/db/schema/` - All schema files
- `apps/crm/src/lib/db/index.ts` - Database connection
- `apps/crm/drizzle.config.ts` - Drizzle configuration
- `apps/crm/drizzle/` - All migration files
- `apps/crm/package.json` - Database scripts and dependencies
- `packages/db/` - Database package exports
- `tests/rls/` - RLS test files (if exist)

**Cursor Prompt:**

```
Perform comprehensive validation of our Safety business schema integration with the existing Supabase setup:

1. **Existing Auth & Training Schema Validation:**
   - Verify original auth.users and related tables are untouched
   - Verify existing safety training tables (profiles, plants, courses, etc.) are preserved
   - Test existing authentication flow is still functional
   - Confirm auth policies and training table policies remain intact
   - Validate current user session management works correctly
   - Check that existing auth and training metadata structure is preserved

2. **New Safety Business Schema Status:**
   - Test Drizzle connection can access all new Safety business tables
   - Verify Safety business table structure matches schema definitions  
   - Validate foreign key relationships between Safety business entities
   - Check that Safety business-to-auth user linkages are working
   - Test that new migrations executed successfully

3. **RLS Policy Integration:**
   - Run RLS tests on new Safety business tables: `npm run test:rls`
   - Verify territory-based access control for Safety business data
   - Test role-based permissions without affecting auth or training policies
   - Check data isolation between territories is enforced
   - Validate auth users can access appropriate Safety business data

4. **Type Safety & Integration:**
   - Compile TypeScript on combined auth + training + Safety business schema definitions
   - Verify Drizzle generates correct types for all schemas
   - Test query type inference across auth-Safety business relationships
   - Validate no type conflicts between existing and new schemas
   - Check that combined queries work correctly

5. **Cross-Schema Query Performance:**
   - Test CRUD operations on Safety business tables and auth linkages
   - Run EXPLAIN ANALYZE on auth-user to Safety business entity queries
   - Verify indexes exist for new foreign key relationships
   - Check response times for territory-filtered queries
   - Test pagination performance on Safety business data with RLS filtering

6. **Integration Data Integrity:**
   - Verify Safety business foreign keys to auth.users work correctly
   - Test territory and role assignment constraints
   - Check audit fields populate correctly on Safety business tables
   - Validate enum types for Safety business-specific values
   - Test that RLS doesn't break auth or training operations

**Generate a comprehensive integration health report with:**
- ğŸ“Š Auth and training schema preservation status and Safety business schema creation status
- ğŸ”— Cross-schema relationship validation results
- ğŸ”’ RLS policy test results for Safety business tables (preserving auth and training policies)
- âš¡ Query performance for auth-Safety business integrated operations
- ğŸš¨ Any schema conflicts or integration issues
- ğŸ“ Recommendations for index optimizations or policy adjustments
- ğŸ¯ Readiness score for building Safety business API contracts

Include specific SQL commands to resolve any integration issues.
```

**Expected Output:**
- Complete auth+Safety schema integration assessment
- RLS policy test results for new Safety tables
- Cross-schema relationship validation
- Performance benchmarks for integrated queries
- Specific recommendations for any integration issues

**When to Use This Check-in:**
- After completing Safety schema setup (steps 04-06)
- Before building Safety API contracts and DTOs
- When experiencing auth-Safety integration issues
- After any changes to schema relationships or RLS policies

---

**Next Phase:** If database is healthy âœ…, proceed to `07-dto-zod-schemas.md`
**If Issues:** Address database problems before building contracts